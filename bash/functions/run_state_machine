#!/usr/bin/env bash
function run_state_machine() {
    STATE_MACHINE=$(aws stepfunctions list-state-machines --query "stateMachines[?contains(name, \`$1\`)].name" --output text | cut -f 3)
    COUNT=$(echo -n "${STATE_MACHINE}" | grep -c "^")
    if [[ "${COUNT}" == 0 ]]; then
        echo "No state machine found with name containing $1"
        return
    elif [[ "${COUNT}" -gt 1 ]]; then
        echo "Multiple state machines found with name containing $1"
        printf '%s\n' "${STATE_MACHINE}"
        return
    fi
    if [[ -z "${2}" ]]; then
        EXECUTION=$(aws stepfunctions start-execution --state-machine-arn "${STATE_MACHINE}" --output text | cut -f 1)
    else
        EXECUTION=$(aws stepfunctions start-execution --state-machine-arn "${STATE_MACHINE}" --input "${2}" --output text | cut -f 1)
    fi
    while true; do
        EXECUTION_STATUS=$(aws stepfunctions describe-execution --execution-arn "${EXECUTION}" --query "status" --output text)
        if [[ "${EXECUTION_STATUS}" == "SUCCEEDED" ]]; then
            echo "Execution ${EXECUTION} succeeded"
            break
        elif [[ "${EXECUTION_STATUS}" == "FAILED" ]]; then
            echo "Execution ${EXECUTION} failed"
            aws stepfunctions describe-execution --execution-arn "${EXECUTION}" --query "{status:status,error:error,cause:cause}" --no-cli-pager | \
                jq '{status: .status, error: .error, cause: (.cause as $cause | try ($cause | fromjson) catch $cause)}'
            break
        fi
        echo "Execution is ${EXECUTION_STATUS}"
        sleep 5
    done
}

alias rsm=run_state_machine
